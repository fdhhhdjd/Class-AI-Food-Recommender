<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI G·ª£i √Ω m√≥n ƒÉn ‚Äî Code Web Kh√¥ng Kh√≥</title>
  <style>
    :root{
      --accent:#007aff;
      --muted:#6b7280;
      --bg:#f3f6fb;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg); color:#111;
    }
    header{
      background:linear-gradient(90deg,var(--accent),#00c6ff); color:white;
      padding:18px 24px; text-align:center; font-weight:700; font-size:1.25rem;
    }
    main{max-width:1100px; margin:22px auto; padding:18px;}
    .kiosk{
      display:grid; grid-template-columns: 1fr 420px; gap:18px;
    }
    /* left area: product grid */
    .panel{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(16,24,40,0.06);}
    .panel h3{margin:0 0 12px 0}
    .grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap:12px;
    }
    .product{
      border-radius:10px; overflow:hidden; background:#fff; border:1px solid #eef2f7; cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      display:flex; flex-direction:column; height:100%;
    }
    .product:hover{transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.08);}
    .product.selected{outline:3px solid rgba(0,122,255,0.12); box-shadow:0 10px 30px rgba(2,6,23,0.12);}
    .product img{width:100%; height:110px; object-fit:cover; display:block;}
    .product .info{padding:10px; display:flex; flex-direction:column; gap:6px; flex:1}
    .product .title{font-weight:600; font-size:0.98rem}
    .product .meta{font-size:0.85rem; color:var(--muted); display:flex; justify-content:space-between; align-items:center}
    .badge{background:#eef6ff;color:var(--accent);padding:4px 8px;border-radius:999px;font-size:0.75rem}
    /* right area: cart + controls + results */
    .side{display:flex; flex-direction:column; gap:12px}
    .controls{display:flex; gap:8px; align-items:center}
    .select{padding:8px 12px; border-radius:8px; border:1px solid #e6eefc; background:#f9fbff}
    .btn{
      background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow:0 6px 18px rgba(0,122,255,0.14)
    }
    .btn.secondary{background:#fff; color:var(--accent); border:1px solid #e6eefc}
    .cart{padding:12px; border-radius:10px; background:#fbfdff; border:1px solid #eef5ff}
    .cart h4{margin:0 0 8px 0}
    .picked{display:flex; gap:8px; flex-wrap:wrap}
    .picked .p{display:flex; gap:8px; align-items:center; padding:6px 8px; background:#fff; border-radius:8px; border:1px solid #eee}
    .picked img{width:40px; height:28px; object-fit:cover; border-radius:6px}
    .results{padding:12px; border-radius:10px; background:#fff; border:1px solid #eef2f7; max-height:420px; overflow:auto;}
    .result-item{display:flex; gap:12px; padding:10px; border-radius:8px; align-items:center; border-bottom:1px dashed #f1f5f9}
    .result-item:last-child{border-bottom:none}
    .ri-img{width:80px; height:64px; border-radius:8px; object-fit:cover; flex-shrink:0}
    .ri-body{flex:1}
    .ri-title{font-weight:700}
    .ri-sub{font-size:0.85rem; color:var(--muted)}
    .tag{display:inline-block;padding:6px 8px;border-radius:6px;background:#fff7ef;color:#d97706;border:1px solid #fff0e6;font-size:0.78rem;margin-left:8px}
    footer{margin-top:18px;text-align:center;color:#6b7280;font-size:0.9rem}
    @media (max-width:980px){
      .kiosk{grid-template-columns:1fr; padding-bottom:20px}
      .side{order:2}
    }
    /* n√∫t xo√° trong gi·ªè */
    .p .remove-btn{
    margin-left:8px;
    background:#ff4d4f;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:4px 8px;
    cursor:pointer;
    font-weight:700;
    font-size:0.85rem;
    }
.p .remove-btn:hover{opacity:0.9}

  </style>
</head>
<body>
  <header>üçΩÔ∏è AI G·ª£i √Ω m√≥n ƒÉn ‚Äî Code Web Kh√¥ng Kh√≥</header>
  <main>
    <div class="kiosk">
      <div class="panel">
        <h3>Ch·ªçn m√≥n (ch·∫°m / click ƒë·ªÉ ch·ªçn)</h3>
        <div id="dishContainer" class="grid">ƒêang t·∫£i...</div>
      </div>

      <div class="side">
        <div class="panel cart">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4>Gi·ªè ch·ªçn</h4>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="topN" class="select"><option value="3">3</option><option value="5">5</option><option value="8">8</option></select>
              <button id="recommendBtn" class="btn">G·ª£i √Ω</button>
            </div>
          </div>

          <div style="margin-top:8px" class="picked" id="pickedList">
            <div style="color:var(--muted)">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c ch·ªçn.</div>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-size:0.9rem">
            B·∫°n c√≥ th·ªÉ ch·ªçn nhi·ªÅu m√≥n ƒë·ªÉ h·ªá th·ªëng hi·ªÉu kh·∫©u v·ªã chung.
          </div>
        </div>

        <div class="panel results" id="resultsBox">
          <h4 style="margin-top:0">K·∫øt qu·∫£ g·ª£i √Ω</h4>
          <div id="resultList">Ch∆∞a c√≥ k·∫øt qu·∫£.</div>
        </div>

        <div style="display:flex;gap:8px">
          <button id="precomputeBtn" class="btn secondary">Precompute (build cache)</button>
          <button id="clearCacheBtn" class="btn secondary">X√≥a cache</button>
        </div>
      </div>
    </div>

    <footer>¬© 2025 ‚Äî AI Recommend ‚Ä¢ Code Web Kh√¥ng Kh√≥</footer>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api";
    const dishContainer = document.getElementById("dishContainer");
    const pickedList = document.getElementById("pickedList");
    const recommendBtn = document.getElementById("recommendBtn");
    const resultList = document.getElementById("resultList");
    const topSelect = document.getElementById("topN");
    const precomputeBtn = document.getElementById("precomputeBtn");
    const clearCacheBtn = document.getElementById("clearCacheBtn");

    let dishes = [];
    const selected = new Set();

    async function loadItems(){
      dishContainer.innerHTML = "ƒêang t·∫£i...";
      try{
        const res = await fetch(`${API_BASE}/items`);
        if(!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i items");
        dishes = await res.json();
        renderGrid();
      } catch(e){
        dishContainer.innerHTML = `<div style="color:#ef4444">L·ªói: ${e.message}</div>`;
      }
    }

    function renderGrid(){
      dishContainer.innerHTML = "";
      dishes.forEach(d => {
        const el = document.createElement("div");
        el.className = "product";
        el.dataset.id = d.id;
        el.innerHTML = `
          <img src="${d.img || 'https://picsum.photos/seed/' + d.id + '/400/300'}" alt="${escapeHtml(d.name)}" loading="lazy">
          <div class="info">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="title">${escapeHtml(d.name)}</div>
              <div class="badge">${d.category}</div>
            </div>
            <div class="meta"><div style="color:#111;font-weight:700">${formatPrice(d.price)}</div><div style="font-size:0.8rem;color:#64748b">ID:${d.id}</div></div>
          </div>
        `;
        el.onclick = () => toggleSelect(d.id, el);
        dishContainer.appendChild(el);
      });
    }

    function toggleSelect(id, el){
      if(selected.has(id)){
        selected.delete(id);
        el.classList.remove("selected");
      } else {
        selected.add(id);
        el.classList.add("selected");
      }
      renderPicked();
    }

    function renderPicked(){
        if(selected.size === 0){
            pickedList.innerHTML = '<div style="color:var(--muted)">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c ch·ªçn.</div>';
            return;
        }
        pickedList.innerHTML = "";
        Array.from(selected).forEach(id => {
            const it = dishes.find(d => d.id === id);
            if(!it) return;
            const p = document.createElement("div");
            p.className = "p";
            // remove button
            const removeBtn = `<button class="remove-btn" data-id="${it.id}" title="X√≥a">‚úï</button>`;
            p.innerHTML = `<img src="${it.img}" alt="${escapeHtml(it.name)}"><div style="min-width:120px">${escapeHtml(it.name)}<div style="font-size:0.82rem;color:var(--muted)">${formatPrice(it.price)}</div></div>${removeBtn}`;
            // attach click for remove
            p.querySelector(".remove-btn").addEventListener("click", (ev) => {
            ev.stopPropagation();
            removeFromSelected(it.id);
            });
            pickedList.appendChild(p);
        });
    }


    // call recommend
    recommendBtn.onclick = async () => {
      if(selected.size === 0){ alert("Ch·ªçn √≠t nh·∫•t 1 m√≥n!"); return; }
      resultList.innerHTML = "<div style='color:var(--muted)'>‚è≥ ƒêang g·ª£i √Ω...</div>";
      const payload = { history: Array.from(selected), top: parseInt(topSelect.value), use_cache: true };
      try{
        const res = await fetch(`${API_BASE}/recommend`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if(!res.ok){ const txt = await res.text(); throw new Error(txt || "API error"); }
        const data = await res.json();
        renderResults(data.results);
      } catch(e){
        resultList.innerHTML = `<div style="color:#ef4444">L·ªói: ${e.message}</div>`;
      }
    };

    function renderResults(results){
      if(!results || results.length === 0){ resultList.innerHTML = "<div style='color:var(--muted)'>Kh√¥ng c√≥ k·∫øt qu·∫£</div>"; return; }
      resultList.innerHTML = "";
      // Build map for quick pair check
      const id2item = {}; dishes.forEach(d => id2item[d.id]=d);
      // Collect declared pairs from selected history
      const declared_pairs = new Set();
      Array.from(selected).forEach(hid => {
        const hist = id2item[hid];
        if(hist && Array.isArray(hist.pair)) hist.pair.forEach(pid => declared_pairs.add(pid));
      });

      results.forEach(r => {
        const div = document.createElement("div");
        div.className = "result-item";
        const img = document.createElement("img");
        img.src = (id2item[r.id] && id2item[r.id].img) ? id2item[r.id].img : ("https://picsum.photos/seed/" + r.id + "/200/160");
        img.className = "ri-img";
        const body = document.createElement("div");
        body.className = "ri-body";
        const title = document.createElement("div");
        title.className = "ri-title";
        title.textContent = r.name;
        const sub = document.createElement("div");
        sub.className = "ri-sub";
        // badges
        const badges = [];
        if(declared_pairs.has(r.id)) badges.push('<span class="tag">Pair ‚úì</span>');
        // same category?
        const histCats = new Set(Array.from(selected).map(hid => (id2item[hid]||{}).category).filter(Boolean));
        if(histCats.size>0 && histCats.has(r.category)) badges.push('<span class="tag" style="background:#e6f8ff;color:#0369a1;border-color:#e6f8ff">Same category</span>');

        sub.innerHTML = `ƒê·ªô t∆∞∆°ng ƒë·ªìng: <strong style="color:var(--accent)">${(r.score*100).toFixed(1)}%</strong> ‚Ä¢ ${r.category ? r.category : ''} ${badges.join(' ')}`;
        body.appendChild(title);
        body.appendChild(sub);
        div.appendChild(img);
        div.appendChild(body);
        resultList.appendChild(div);
      });
    }

    // precompute and clear cache helpers
    precomputeBtn.onclick = async () => {
      precomputeBtn.disabled = true; precomputeBtn.textContent = "ƒêang build cache...";
      try{
        const res = await fetch(`${API_BASE}/precompute`, {method:"POST"});
        const data = await res.json();
        alert("Precompute xong: " + JSON.stringify(data));
      } catch(e){
        alert("Precompute l·ªói: " + e.message);
      } finally{ precomputeBtn.disabled=false; precomputeBtn.textContent="Precompute (build cache)"; }
    };

    clearCacheBtn.onclick = async () => {
      if(!confirm("X√≥a file cache (data/items_with_vecs.json)?")) return;
      try{
        const res = await fetch(`${API_BASE}/cache/clear`, {method:"DELETE"});
        const data = await res.json();
        alert("Cache cleared: " + JSON.stringify(data));
      } catch(e){
        alert("X√≥a cache l·ªói (server c√≥ th·ªÉ ch∆∞a h·ªó tr·ª£ endpoint): " + e.message);
      }
    };
    

    function removeFromSelected(id){
        if(selected.has(id)){
            selected.delete(id);
            // remove selected class from grid item
            const node = dishContainer.querySelector(`.product[data-id="${id}"]`);
            if(node) node.classList.remove("selected");
            renderPicked();
        }
    }


    // util
    function formatPrice(p){ return p ? p.toLocaleString('vi-VN') + " ƒë" : ""; }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // init
    loadItems();
  </script>
</body>
</html>
